<!DOCTYPE html>
<html>
<head>
	<title>natural selection</title>
	<canvas id="canvas" style="position: absolute; top: 0; left: 0; border:1px solid #000000;"></canvas>
	<canvas id="speedChart" style="position: absolute; top: 0; left: 0; border:1px solid #000000;"></canvas>
	<canvas id="senseChart" style="position: absolute; top: 0; left: 0; border:1px solid #000000;"></canvas>

	<script src="../geometry.js"></script>
	<script src="../Vectors.js"></script>
</head>
<body>


<!-- Builds the map -->
<script src="canvas.js"></script>

<!-- Draws the creatures -->
<script src="creatures.js"></script>
<script src="food.js"></script>

<!-- Manage epochs. An "epoch" is a round -->
<script src="epoch.js"></script>

<!-- Draw the chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script src="chart.js"></script>
  
<script>

let creatures1 = []
// for (let x = 50; x < map.width; x+= 100) {
// 	creatures1.push(new Creature(new Vector(x, 50), new Vector(0, 1) ) )
// 	creatures1.push(new Creature(new Vector(x, map.height - 50), new Vector(0, -1) ) )
// }

creatures1.push(new Creature(new Vector(50, 50), new Vector(0, 1), 1 ) )
creatures1.push(new Creature(new Vector(250, 50), new Vector(0, 1), 1 ) )

foodArray = generateFood(100)

epochArray = [new Epoch(creatures1, foodArray)]

const GAMESPEED = 3

drawDividerLine()

epoch = epochArray[epochArray.length - 1]

// Use this as a function
function setup() {}

const countMap = (array) => {
	return new Map([...new Set(array)].map(x => [x, array.filter(y => y ==x).length]).sort())
}
function rgb(r, g, b){
  return "rgb("+r+","+g+","+b+")";
}

function run() {
	
	wipeScreen();
	drawDividerLine()
	const uneatenFood = epoch.food.filter(food => !food.eaten)
	const aliveCreatures = epoch.creatures.filter(creature => creature.energy > 0)
	if (aliveCreatures.length == 0 || uneatenFood == 0) {
		nextEpoch(epoch, epochArray)
		epoch = epochArray[epochArray.length - 1]

		const speeds = epoch.creatures.map(creature => creature.speed.toFixed(2))
		const speedMap = countMap(speeds)
		speedChart.data.labels = Array.from(speedMap.keys())
		speedChart.data.datasets[0].data = Array.from(speedMap.values())
		speedChart.update()

		const senses = epoch.creatures.map(creature => creature.sense.toFixed(2))
		const senseMap = countMap(senses)
		senseChart.data.labels = Array.from(senseMap.keys())
		senseChart.data.datasets[0].data = Array.from(senseMap.values())
		senseChart.update()
	}

	aliveCreatures.forEach(creature => {
		creature.draw();
		creature.drawSense();
		// creature.drawEnergy();
		creature.drawSpeed();
		// creature.drawFoodEaten();
		creature.detectFood(uneatenFood);
		creature.move();
	})
	arrow(500, 1000, this.size/2)

	epoch.food.forEach(food => {
		if ( !food.eaten) {
			food.draw()
		} 
	})
	requestAnimationFrame(run);
}

run();
</script>